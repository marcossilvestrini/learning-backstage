- name: Update the repositories and install PostgreSQL and its tools
  dnf:
    name: "postgresql-server,postgresql-contrib,postgresql"
    state: present

- name: Check if PostgreSQL is already initialized
  shell: systemctl is-active postgresql
  register: postgresql_status
  changed_when: false

- name: Initialize the PostgreSQL database and enable it to start on boot
  become_user: postgres
  command: postgresql-setup --initdb
  ignore_errors: true
  when: postgresql_status.stdout != "active"

- name: Find PostgreSQL pg_hba.conf file
  shell: "find / -name pg_hba.conf 2>/dev/null | head -n 1 || true"
  register: pg_hba_conf
  changed_when: false

- name: Configure PostgreSQL to use "md5" authentication for "postgres" user
  lineinfile:
    path: "{{ pg_hba_conf.stdout }}"
    regexp: '^local\s+all\s+all\s+peer'
    line: '#local   all             all                                     peer'
  when: pg_hba_conf.stdout is defined

- name: Uncomment PostgreSQL authentication for "postgres" user
  lineinfile:
    path: "{{ pg_hba_conf.stdout }}"
    regexp: '^#local\s+all\s+postgres\s+md5'
    line: 'local   all             postgres                                md5'
  when: pg_hba_conf.stdout is defined

- name: Enable PostgreSQL to start on boot
  systemd:
    name: postgresql
    enabled: yes

- name: Restart PostgreSQL service to apply the new password
  systemd:
    name: postgresql
    state: restarted
  
- name: Update the password for the postgres user
  shell: "sudo -u postgres psql -c \"ALTER USER postgres PASSWORD '{{ postgres_password }}'\""
  ignore_errors: true


